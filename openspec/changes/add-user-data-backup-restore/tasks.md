## 1. OpenSpec and Rule Lock
- [ ] 1.1 Confirm v1 rules `BR-001` to `BR-042` are represented in proposal/design/spec files.
- [ ] 1.2 Validate OpenSpec change with `openspec validate add-user-data-backup-restore --strict`.

## 2. Backend Contracts and Command Surface
- [ ] 2.1 Add `src-tauri/src/commands/backup.rs` and register commands in `src-tauri/src/commands/mod.rs`.
- [ ] 2.2 Define typed request/response contracts in Rust and generated frontend bindings:
  - [ ] `CreateBackupRequest` with scope (`full` or `lightweight`) and user-selected output path.
  - [ ] `CreateBackupReport` with counts, warnings, output path, and duration.
  - [ ] `PreflightRestoreRequest` and `PreflightRestoreReport` (default summary MUST include `backup_created_at` + `backup_history_entries`; optional detailed findings include full backup metadata and side-by-side counts).
  - [ ] `ApplyRestoreRequest` and `ApplyRestoreReport`.
  - [ ] `BackupProgress` event payload with `phase`, `current`, `total` (`estimated_seconds_remaining` optional best-effort).
  - [ ] `EstimateSizeRequest` and `EstimateSizeReport`.
  - [ ] `StartupRestoreReconciliationReport` payload for user-facing post-crash outcome summary with standardized `outcome` enum (`rolled_back`, `committed`, `no_action`) and phase context.
- [ ] 2.3 Add an app-level operation mutex so only one backup/restore runs concurrently (`BR-016`).
- [ ] 2.4 Add operation cancel token plumbing for export/restore flows (`BR-020`).
- [ ] 2.5 Add persistent restore-in-progress marker state for crash reconciliation (`BR-021`).
- [ ] 2.6 Add restore quiesce-mode state/plumbing to block new transcription/history writes during apply-restore (`BR-034`).
- [ ] 2.11 Add typed `restore_in_progress` blocked-action response/event contract so hotkey/tray/UI entry points can show consistent status.
- [ ] 2.12 Add internal `RestorePhase` marker enum: `snapshot_ready`, `active_moved`, `staged_activated`, `completed`.

## 3. Export Pipeline Implementation
- [ ] 3.1 Implement archive workspace builder that writes exact layout required by `BR-002` (including `settings/settings.json`).
- [ ] 3.2 Implement estimated archive size calculation and preview (`BR-029`).
- [ ] 3.3 Implement history logical export (`BR-005`):
  - [ ] query `transcription_history` rows into `history/history.jsonl`.
  - [ ] query `user_stats` into `history/user_stats.json`.
  - [ ] do not copy `history.db` into backup artifact.
- [ ] 3.4 Implement dictionary export from settings payload into `dictionary/dictionary.json`.
- [ ] 3.5 Implement selective settings export into `settings/settings.json` (`BR-026`):
  - [ ] include user-configurable preferences.
  - [ ] exclude `post_process_api_keys` (sensitive).
  - [ ] exclude `selected_microphone`, `clamshell_microphone`, `selected_output_device`, `selected_model` (device-specific).
  - [ ] exclude `debug_mode` (runtime state).
  - [ ] include `settings_payload_version`.
- [ ] 3.6 Implement scope handling (`BR-006`):
  - [ ] full scope copies available referenced recordings.
  - [ ] lightweight scope omits `recordings/` but still includes history, dictionary, and settings payloads.
- [ ] 3.7 Implement missing-recording warning behavior for full backups (`BR-007`).
- [ ] 3.8 Implement cross-platform path normalization: forward-slash separators, NFC Unicode, invalid character validation (`BR-030`).
- [ ] 3.9 Implement manifest generation with required fields including `platform` and `estimated_size_bytes` (`BR-003`).
- [ ] 3.10 Implement SHA-256 checksum file generation for all payload files (`BR-004`).
- [ ] 3.11 Package workspace into `.codictatebackup` ZIP and write output atomically (`BR-001`).
- [ ] 3.12 Return `CreateBackupReport` with counts and warnings (`BR-015`).
- [ ] 3.13 Add export storage-capacity precheck for both temp workspace and destination (`BR-019`):
  - [ ] validate destination can accept the estimated archive write (free-space and filesystem constraints).
  - [ ] return concise actionable failure guidance without additional decision matrices.
- [ ] 3.14 Add export cancellation checkpoints and temp/output cleanup behavior (`BR-020`).
- [ ] 3.15 Emit progress events at each major step (`BR-028`); ETA is optional best-effort metadata.
- [ ] 3.16 Add export destination filename guardrails:
  - [ ] prefill save dialog with `codictate-backup-YYYY-MM-DD_HH-mm.codictatebackup`.
  - [ ] auto-append `.codictatebackup` when omitted.
  - [ ] require explicit overwrite confirmation for existing destination files.
- [ ] 3.17 Add short export snapshot consistency fence (`BR-041`):
  - [ ] briefly block new history/settings writes only for snapshot capture.
  - [ ] capture history rows, stats, dictionary/settings from one point-in-time snapshot.
  - [ ] release fence immediately after snapshot capture.

## 4. Restore Preflight Implementation
- [ ] 4.1 Validate archive entry safety from archive metadata before file-content extraction (reject traversal, absolute path, symlink/hardlink entries) (`BR-018`).
- [ ] 4.2 Implement archive unpack to temp workspace only after `4.1` safety checks pass.
- [ ] 4.3 Validate required files exist including `settings/settings.json` (`BR-002`).
- [ ] 4.4 Parse and validate manifest fields including `platform` (`BR-003`).
- [ ] 4.5 Verify checksums before any write (`BR-004`, `BR-008`).
- [ ] 4.6 Enforce compatibility policy for known payload versions within format major `1` and documented major-transition runway (`BR-009`).
- [ ] 4.7 Normalize extracted filenames to NFC Unicode and validate cross-platform filename safety with issue classification (`BR-030`).
- [ ] 4.8 Add restore storage-capacity precheck including rollback workspace size (`BR-019`).
- [ ] 4.9 Build and return `PreflightRestoreReport` with:
  - [ ] compatibility result
  - [ ] concise impact counts in the default summary, including `backup_created_at` and `backup_history_entries`
  - [ ] payload counts
  - [ ] concise user-facing summary (plain language; not overwhelming)
  - [ ] blocking findings list (must abort)
  - [ ] recoverable findings list (auto-continued when only optional recording-file issues exist)
  - [ ] optional detailed findings payload for explicit `View details` UX, including side-by-side counts and backup identity metadata
  - [ ] warning list (including missing recordings declared by manifest)
- [ ] 4.10 Enforce hard non-overridable resource limits during preflight/import (`BR-035`):
  - [ ] compression ratio and absolute parser ceilings are blocking failures.
  - [ ] bounded streaming parsing remains enabled for all JSON/JSONL payloads.
- [ ] 4.11 Include integrity-scope disclosure in preflight result payload/UI model (`BR-036`).

## 5. Restore Apply Implementation (Replace-Only)
- [ ] 5.1 Implement pre-swap rollback snapshot of active data and automatic rollback on failure/crash (`BR-024`):
  - [ ] create rollback workspace snapshot before final swap.
  - [ ] validate rollback snapshot can be restored.
  - [ ] restore from rollback snapshot on failure/interruption.
  - [ ] retain latest snapshot for 7 days and cleanup older snapshots (`BR-042`).
- [ ] 5.2 Add explicit restore-managed dataset resolver/validator (`BR-038`) for:
  - [ ] active `history.db` (including stats tables).
  - [ ] dictionary source state in `settings_store.json`.
  - [ ] restore-managed `recordings/` subtree.
- [ ] 5.3 Implement component migration pipeline (`BR-010`) for history payload, dictionary payload, and settings payload versions.
- [ ] 5.4 Create staging restore area with fresh DB initialized through current migrations.
- [ ] 5.5 Import migrated history rows into staging DB.
- [ ] 5.6 Recompute `user_stats` from imported history rows (`BR-025`):
  - [ ] recalculate `total_words`, `total_duration_ms`, `total_transcriptions`, `transcription_dates`, `total_filler_words_removed`.
- [ ] 5.7 Import dictionary payload into staged settings payload.
- [ ] 5.8 Merge settings selectively into staged settings, applying forward-compatible defaults for new/missing fields (`BR-027`):
  - [ ] fields present in backup → restore.
  - [ ] fields missing from backup but in current schema → keep defaults.
  - [ ] fields in backup but removed from schema → silently ignore.
- [ ] 5.9 Copy recordings from archive when present.
- [ ] 5.10 Implement strict core payload validation (`BR-022`):
  - [ ] malformed history rows in required payload are blocking restore errors.
  - [ ] invalid dictionary/settings payloads are blocking restore errors.
  - [ ] optional recording filename/file issues are skipped with recoverable warnings.
  - [ ] references for skipped recordings resolve to audio-unavailable runtime state.
- [ ] 5.11 Run staging validation:
  - [ ] SQLite integrity check passes.
  - [ ] payload counts match import counts.
- [ ] 5.12 Add same-volume atomicity guard before destructive swap (`BR-039`):
  - [ ] verify active/staging/rollback roots are same-volume.
  - [ ] block restore before destructive phase when atomic rename is not guaranteed.
- [ ] 5.13 Execute replace-only swap using atomic renames only (`BR-011`, `BR-012`, `BR-039`):
  - [ ] rename active restore-managed data to rollback location and set marker `active_moved`.
  - [ ] rename staged data into active app data paths and set marker `staged_activated`.
  - [ ] forbid copy/delete swap semantics.
- [ ] 5.14 Implement phase-based marker transitions and deterministic reconciliation (`BR-040`):
  - [ ] set marker `snapshot_ready` after rollback snapshot validation.
  - [ ] map `active_moved` -> rollback recovery.
  - [ ] map `staged_activated` -> commit finalization.
  - [ ] set/clear `completed` state on successful finish.
- [ ] 5.15 Implement rollback path on any failure (`BR-013`).
- [ ] 5.16 Emit state refresh events (history/settings) after successful restore.
- [ ] 5.17 Return `ApplyRestoreReport` with restored counts, warnings, and failures (`BR-015`).
- [ ] 5.18 Add restore cancellation checkpoints and cleanup behavior (`BR-020`).
- [ ] 5.19 Implement startup reconciliation using restore-in-progress marker (`BR-021`) and standardized `outcome` enum.
- [ ] 5.20 Emit progress events at each major step (`BR-028`); ETA is optional best-effort metadata.
- [ ] 5.21 Ensure restore quiesce mode is entered before apply-restore and always exited on success/failure/rollback (`BR-034`).
- [ ] 5.22 Emit explicit reconciliation outcome event/report at startup so frontend can display post-interruption summary.

## 6. Missing Audio Runtime Behavior
- [ ] 6.1 Update audio lookup/playback flow to detect missing recording file and return typed error instead of crash (`BR-014`).
- [ ] 6.2 Add frontend handling for missing-audio error with clear user message (`BR-014`).
- [ ] 6.3 Ensure lightweight backup restores remain usable for history text even without recordings.

## 7. Frontend UX and Guardrails
- [ ] 7.1 Add backup UI controls in Settings with two scope options only (`full`, `lightweight`) (`BR-006`):
  - [ ] default selection is `full`.
  - [ ] `full` is labeled as comprehensive backup option.
  - [ ] `lightweight` requires explicit user choice and clearly states recordings are excluded while history/dictionary/settings remain included.
- [ ] 7.2 Add estimated archive size preview before export (`BR-029`).
- [ ] 7.3 Add explicit unencrypted notice in export flow (`BR-017`).
- [ ] 7.4 Add progress bar for export and restore operations (`BR-028`), with optional best-effort ETA display.
- [ ] 7.5 Add restore flow with two steps:
  - [ ] Step A: preflight summary view from `PreflightRestoreReport` with concise impact + blocking/recoverable summary.
  - [ ] Step A default summary always shows backup `created_at` + `history_entries`.
  - [ ] Step A includes optional `View details` drill-in for per-item findings.
  - [ ] Step B: replace-only confirmation dialog with `Will restore` and `Will not restore` sections, clearly warning current data will be replaced.
  - [ ] Step B explicitly lists excluded settings (API keys, selected devices, selected model).
  - [ ] Step B explicitly states missing-audio consequences when recordings are absent.
- [ ] 7.7 Show compatibility gate errors and remediation messages for unsupported versions (`BR-009`).
- [ ] 7.8 Show pragmatic success/failure summaries using structured reports (`BR-015`):
  - [ ] default summary is short and confidence-building (`backup is ready` / `restore completed`).
  - [ ] include only key counts/impact in default view.
  - [ ] provide `View details` for full warning/file-level diagnostics.
- [ ] 7.9 Add insufficient disk space warning in export and restore flows (`BR-019`).
- [ ] 7.10 Show integrity-scope disclosure text in restore preflight UI (checksums detect corruption, not trusted-origin authenticity) (`BR-036`).
- [ ] 7.13 Add cancellation UX states (`BR-020`):
  - [ ] show visible cancel action during cancellable phases for export/restore.
  - [ ] show cancel-in-progress cleanup state after user requests cancel.
  - [ ] show explicit non-cancellable commit-phase messaging when cancel is temporarily unavailable.
- [ ] 7.14 Add destination-capacity/error UX for export:
  - [ ] show concise actionable message when destination constraints block export.
  - [ ] avoid additional decision dialogs; user can re-run export with a new destination/scope from the main flow.
- [ ] 7.17 Add startup reconciliation outcome UX:
  - [ ] show minimal post-crash restore reconciliation summary with outcome and timestamp.
- [ ] 7.18 Add accessibility guardrails for backup/restore UI:
  - [ ] keyboard-only operation for all dialogs and actions.
  - [ ] focus trap/restore and safe default focus in destructive dialogs.
  - [ ] screen-reader announcements for progress/warnings/failure/completion.
  - [ ] non-color-only severity cues and accessible contrast in warning/error states.
- [ ] 7.19 Add export destination UX guardrails:
  - [ ] prefill save dialog with default `codictate-backup-YYYY-MM-DD_HH-mm.codictatebackup`.
  - [ ] auto-append `.codictatebackup` when omitted.
  - [ ] show explicit overwrite confirmation for existing files.
- [ ] 7.20 Add quiesce blocked-action UX across all entry points:
  - [ ] hotkey/tray/main UI transcription attempts show consistent `restore in progress` message.

## 8. Permissions and Capabilities
- [ ] 8.1 Configure Tauri capabilities for backup/restore:
  - [ ] `dialog:allow-save` — file-save dialog for export destination.
  - [ ] `dialog:allow-open` — file-open dialog for restore source.
  - [ ] `fs:allow-read` — scoped to app data dir + user-selected archive paths.
  - [ ] `fs:allow-write` — scoped to app data dir + user-selected archive paths.
  - [ ] `fs:allow-mkdir` — for temp workspace creation.
  - [ ] `fs:allow-remove` — for temp workspace cleanup.
- [ ] 8.2 Ensure restore/export only operate on user-selected files plus app data paths (`BR-023`).

## 9. Structured Logging (`BR-031`)
- [ ] 9.1 Add `info!` logs at every major export milestone (start, snapshot, scan, write, package, complete with counts/duration).
- [ ] 9.2 Add `info!`/`error!` logs at every major restore milestone (preflight, rollback snapshot, migration, staging, swap, rollback, reconciliation).
- [ ] 9.3 Add `warn!` logs for all recoverable warnings (missing recordings, skipped malformed rows, skipped invalid optional filenames, low space).
- [ ] 9.4 Add frontend `logInfo`/`logError` calls with target `fe-backup` for all user-initiated backup/restore actions.
- [ ] 9.5 Add `debug!` logs for intermediate steps using metadata only (counts/indices), never raw row payload content (`BR-037`).
- [ ] 9.6 Add centralized redaction guard/helper and apply it to backend/frontend backup logs (`BR-037`).

## 10. Internationalization (`BR-032`)
- [ ] 10.1 Add all backup/restore UI strings to `src/i18n/locales/en/translation.json` under `settings.backup` namespace.
- [ ] 10.2 Use `t()` for all user-facing text in backup/restore components.
- [ ] 10.3 Include: scope labels, unencrypted notice, preflight summary, replace-only warning, progress messages, missing-audio message, error messages, success messages, estimated size text, current-vs-backup comparison text.

## 11. Test Matrix
- [ ] 11.1 Unit tests for manifest serializer/deserializer and checksum generation (`BR-003`, `BR-004`).
- [ ] 11.2 Unit tests for compatibility gate rules (`BR-009`).
- [ ] 11.3 Unit tests for migration dispatcher and missing migration failure (`BR-010`).
- [ ] 11.4 Unit tests for selective settings export/import and forward-compatible merge (`BR-026`, `BR-027`).
- [ ] 11.5 Unit tests for user stats recomputation from history rows (`BR-025`).
- [ ] 11.6 Unit tests for cross-platform filename normalization and invalid character sanitization (`BR-030`).
- [ ] 11.7 Integration test: full backup round-trip with recordings (`BR-001`, `BR-006`, `BR-012`).
- [ ] 11.8 Integration test: lightweight backup round-trip without recordings restores history, dictionary, and settings (`BR-006`, `BR-014`, `BR-026`, `BR-027`).
- [ ] 11.9 Integration test: preflight rejects corrupted archive (checksum mismatch) (`BR-004`, `BR-008`).
- [ ] 11.10 Integration test: preflight rejects too-old and forward-incompatible versions (`BR-009`).
- [ ] 11.11 Integration test: restore failure triggers rollback and preserves exact pre-restore history/stats/dictionary state (`BR-013`, `BR-038`).
- [ ] 11.12 Integration test: missing recordings in full export produce warnings but export succeeds (`BR-007`).
- [ ] 11.13 Integration test: pre-swap rollback snapshot is created before destructive swap (`BR-024`).
- [ ] 11.14 Integration test: settings selective merge restores preferences but not API keys (`BR-026`, `BR-027`).
- [ ] 11.15 Integration test: backup from older app version restores with defaults for new fields (`BR-027`).
- [ ] 11.16 Integration test: progress events are emitted during export and restore (`BR-028`) without requiring ETA.
- [ ] 11.17 Integration test: estimated size preview matches actual archive size within tolerance (`BR-029`).
- [ ] 11.18 Frontend tests for unencrypted notice, concise preflight summary, replace-only warning, progress bar, and missing-audio message.
- [ ] 11.19 Integration test: archive path traversal entry is rejected (`BR-018`).
- [ ] 11.20 Integration test: archive symlink/hardlink entry is rejected (`BR-018`).
- [ ] 11.21 Integration test: low-disk export and restore prechecks fail safely (`BR-019`).
- [ ] 11.22 Integration test: cancel export and restore clean up temp artifacts and keep active data intact (`BR-020`).
- [ ] 11.23 Integration test: crash/interruption during restore reconciles safely on next startup with deterministic marker-phase outcomes (`BR-021`, `BR-040`).
- [ ] 11.25 Integration test: concurrent backup/restore request is rejected while operation lock is held (`BR-016`).
- [ ] 11.26 Integration test: out-of-scope path operations are rejected (`BR-023`).
- [ ] 11.27 Integration test: cross-platform backup created on macOS restores correctly on Linux (`BR-030`).
- [ ] 11.30 Integration test: restore quiesce mode blocks new writes during apply-restore and is released after completion (`BR-034`).
- [ ] 11.31 Integration test: restore rejects archive exceeding hard security bounds (for example compression-ratio abuse) as blocking (`BR-035`).
- [ ] 11.32 Integration test: restore blocks on malformed required core payload row (`BR-022`).
- [ ] 11.33 Integration test: optional missing/invalid recording files auto-skip with concise summary warning (`BR-033`).
- [ ] 11.34 Integration test: rollback snapshot restores exact pre-restore history/stats/dictionary state on injected swap failure (`BR-024`, `BR-038`).
- [ ] 11.35 Integration test: compatibility migration succeeds across all supported v1 payload versions (`BR-009`, `BR-010`).
- [ ] 11.36 Frontend test: preflight UI shows integrity-scope disclosure text (corruption-detection only) (`BR-036`).
- [ ] 11.37 Unit/integration test: backup/restore logs never contain transcript text, prompt text, API keys, or raw payload bodies (`BR-037`).
- [ ] 11.39 Frontend test: backup export defaults to `full` and lightweight copy clearly states excluded recordings and included text/settings.
- [ ] 11.40 Integration test: export precheck blocks when destination constraints prevent archive write and returns concise actionable error.
- [ ] 11.41 Frontend test: cancellation UX shows cancel action in cancellable phases, cancel-in-progress state, and commit-phase non-cancellable messaging.
- [ ] 11.42 Integration/frontend test: startup reconciliation outcome is surfaced to user after interrupted restore.
- [ ] 11.43 Frontend test: restore confirmation includes `Will restore` and `Will not restore` sections with explicit exclusion list.
- [ ] 11.47 Accessibility test: backup/restore dialogs and progress flows are keyboard operable with correct focus management.
- [ ] 11.48 Accessibility test: screen readers receive progress/error announcements and warning/error severity is not color-only.
- [ ] 11.50 Frontend test: preflight and completion summaries are concise by default and show detailed diagnostics only via explicit `View details`.
- [ ] 11.51 Frontend test: restore confirmation stays concise by default, always shows backup `created_at` + `history_entries`, and keeps full metadata in optional details view.
- [ ] 11.52 Frontend/integration test: save dialog pre-fills Codictate default filename, auto-appends `.codictatebackup`, and requires overwrite confirmation.
- [ ] 11.54 Integration/frontend test: blocked transcription/history actions during restore quiesce show consistent `restore in progress` messaging.
- [ ] 11.55 Integration test: restore blocks before destructive phase when same-volume atomic rename cannot be guaranteed (`BR-039`).
- [ ] 11.56 Integration test: export under concurrent writes yields one fenced point-in-time history/stats/dictionary snapshot (`BR-041`).
- [ ] 11.57 Integration test: rollback snapshot retention keeps latest snapshot for 7 days and cleans older snapshots (`BR-042`).

## 12. Documentation
- [ ] 12.1 Create `doc/backup-restore.md` with:
  - [ ] Feature overview and user guide with full and lightweight examples.
  - [ ] Clarify default export scope is `full`, and lightweight is an explicit choice with no recordings but still includes history/dictionary/settings.
  - [ ] Document export filename defaults and extension behavior (`codictate-backup-YYYY-MM-DD_HH-mm.codictatebackup`, auto-append, overwrite confirmation).
  - [ ] Architecture Decision Record (ADR): why JSONL over SQLite copy, why ZIP over tar.gz, why replace-only over merge.
  - [ ] Error catalog documenting all user-facing error conditions and messages.
  - [ ] Archive format spec, compatibility window, and migration guidance for unsupported versions.
  - [ ] Integrity scope note: checksums provide corruption detection only in v1 (no trusted-origin authenticity).
  - [ ] Restore hard resource-limit table and operator guidance for limit failures.
  - [ ] Destination filesystem constraint guidance (for example FAT32/exFAT limits) with simple retry guidance.
  - [ ] Document cancellation behavior and non-cancellable commit/rollback phase messaging.
  - [ ] Document rollback snapshot behavior and cleanup retention.
  - [ ] Document concise default summaries and optional `View details` diagnostics for preflight/restore outcomes.
  - [ ] Document startup reconciliation outcome messaging after interrupted restore.
  - [ ] Document accessibility expectations for backup/restore dialogs and progress flows.
  - [ ] Note that v1 backups are unencrypted and suggest external encryption options.
- [ ] 12.2 Update `doc/prodRelease.md` with backup compatibility section:
  - [ ] Pre-release checklist item: verify backup format changes don't break existing user backups.
  - [ ] Consider if schema migrations need updating.
  - [ ] Consider if settings backup inclusion/exclusion lists need updating for new fields.
